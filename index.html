<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Teleprompter</title>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
        }

        /* Text Viewport - Full screen with space for controls at bottom */
        #viewport {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 60px; /* Space for controls */
            overflow: hidden;
            background: #000;
        }

        #text-container {
            padding: 40px;
            color: #fff;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            transition: transform 0.05s linear;
        }

        .sentence {
            display: inline;
        }

        .sentence.current {
            background: rgba(255, 255, 0, 0.2);
        }

        /* Bottom Controls - Fixed at bottom, minimal and compact */
        #controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid #333;
            z-index: 100;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        button {
            background: #333;
            color: #fff;
            border: none;
            padding: 4px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.2s;
            white-space: nowrap;
        }

        button:hover {
            background: #444;
        }

        button:active {
            background: #555;
        }

        button.active {
            background: #0066cc;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            background: #333;
            color: #fff;
            padding: 4px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            display: inline-block;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .file-label:hover {
            background: #444;
        }

        input[type="range"] {
            width: 70px;
            height: 20px;
        }

        label {
            font-size: 10px;
            color: #ccc;
        }

        .value-display {
            min-width: 45px;
            text-align: center;
            font-size: 10px;
            color: #fff;
        }

        .nav-button {
            font-size: 14px;
            padding: 4px 10px;
        }

        .play-pause {
            font-size: 16px;
            padding: 4px 12px;
        }

        #progress-bar {
            flex: 1;
            min-width: 100px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        #progress-fill {
            height: 100%;
            background: #0066cc;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        #progress-percent {
            min-width: 35px;
            text-align: right;
            font-size: 10px;
        }

        /* Paste Modal */
        #paste-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        #paste-modal.show {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        #paste-area {
            width: 100%;
            height: 300px;
            background: #000;
            color: #fff;
            border: 2px solid #333;
            border-radius: 4px;
            padding: 15px;
            font-family: inherit;
            font-size: 14px;
            margin-bottom: 15px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Fullscreen styles */
        #app.fullscreen #controls {
            display: none;
        }

        #app.fullscreen #viewport {
            bottom: 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #controls {
                padding: 6px 8px;
                gap: 6px;
            }

            .control-group {
                gap: 4px;
            }

            button, .file-label {
                padding: 3px 8px;
                font-size: 10px;
            }

            input[type="range"] {
                width: 60px;
            }

            .value-display {
                min-width: 40px;
                font-size: 9px;
            }

            label {
                font-size: 9px;
            }

            #text-container {
                padding: 20px;
            }

            #viewport {
                bottom: 50px;
            }
        }

        /* Loading indicator */
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Text Viewport -->
        <div id="viewport">
            <div id="text-container">
                <p style="color: #666; text-align: center; margin-top: 100px;">
                    Upload a file or paste text to begin
                </p>
            </div>
        </div>

        <!-- Bottom Controls - All controls consolidated -->
        <div id="controls">
            <!-- Playback Controls -->
            <div class="control-group">
                <button id="prev-btn" class="nav-button">‚óÑ</button>
                <button id="play-pause-btn" class="play-pause">‚ñ∂</button>
                <button id="next-btn" class="nav-button">‚ñ∫</button>
            </div>

            <!-- Progress Bar -->
            <div id="progress-bar">
                <div id="progress-fill"></div>
            </div>
            <span id="progress-percent">0%</span>

            <!-- Speed Control -->
            <div class="control-group">
                <input type="range" id="speed-slider" min="60" max="300" value="180" step="10">
                <span class="value-display" id="speed-value">180</span>
            </div>

            <!-- Font Size Control -->
            <div class="control-group">
                <input type="range" id="font-slider" min="24" max="96" value="48" step="4">
                <span class="value-display" id="font-value">48</span>
            </div>

            <!-- File/Paste Controls -->
            <div class="control-group">
                <label for="file-upload" class="file-label">üìÅ</label>
                <input type="file" id="file-upload" accept=".txt,.docx,.md">
                <button id="paste-btn">üìù</button>
                <button id="mirror-btn">‚ü∑</button>
                <button id="vflip-btn">‚áÖ</button>
                <button id="fullscreen-btn">‚õ∂</button>
            </div>
        </div>

        <!-- Paste Modal -->
        <div id="paste-modal">
            <div class="modal-content">
                <h2 style="margin-bottom: 15px;">Paste Your Text</h2>
                <textarea id="paste-area" placeholder="Paste your script here..."></textarea>
                <div class="modal-buttons">
                    <button id="paste-cancel">Cancel</button>
                    <button id="paste-load">Load Text</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== State Management =====
        const state = {
            text: '',
            sentences: [],
            currentSentenceIndex: 0,
            isPlaying: false,
            speed: 180, // WPM
            fontSize: 48,
            mirror: false,
            verticalFlip: false,
            scrollPosition: 0,
            animationFrameId: null,
            lastTimestamp: 0
        };

        // ===== DOM Elements =====
        const elements = {
            app: document.getElementById('app'),
            fileUpload: document.getElementById('file-upload'),
            pasteBtn: document.getElementById('paste-btn'),
            pasteModal: document.getElementById('paste-modal'),
            pasteArea: document.getElementById('paste-area'),
            pasteLoad: document.getElementById('paste-load'),
            pasteCancel: document.getElementById('paste-cancel'),
            mirrorBtn: document.getElementById('mirror-btn'),
            vflipBtn: document.getElementById('vflip-btn'),
            fontSlider: document.getElementById('font-slider'),
            fontValue: document.getElementById('font-value'),
            speedSlider: document.getElementById('speed-slider'),
            speedValue: document.getElementById('speed-value'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            viewport: document.getElementById('viewport'),
            textContainer: document.getElementById('text-container'),
            playPauseBtn: document.getElementById('play-pause-btn'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            progressBar: document.getElementById('progress-bar'),
            progressFill: document.getElementById('progress-fill'),
            progressPercent: document.getElementById('progress-percent')
        };

        // ===== LocalStorage Persistence =====
        function loadSettings() {
            state.speed = parseInt(localStorage.getItem('prompter_speed')) || 180;
            state.fontSize = parseInt(localStorage.getItem('prompter_fontSize')) || 48;
            state.mirror = localStorage.getItem('prompter_mirror') === 'true';
            state.verticalFlip = localStorage.getItem('prompter_verticalFlip') === 'true';

            elements.speedSlider.value = state.speed;
            elements.speedValue.textContent = state.speed;
            elements.fontSlider.value = state.fontSize;
            elements.fontValue.textContent = state.fontSize;
            elements.textContainer.style.fontSize = state.fontSize + 'px';

            if (state.mirror) {
                elements.mirrorBtn.classList.add('active');
            }
            if (state.verticalFlip) {
                elements.vflipBtn.classList.add('active');
            }
            updateTransform();
        }

        function saveSetting(key, value) {
            localStorage.setItem(key, value);
        }

        // ===== Transform Helper =====
        function updateTransform() {
            let transform = `translateY(${state.scrollPosition}px)`;

            if (state.mirror && state.verticalFlip) {
                transform = `scaleX(-1) scaleY(-1) ${transform}`;
            } else if (state.mirror) {
                transform = `scaleX(-1) ${transform}`;
            } else if (state.verticalFlip) {
                transform = `scaleY(-1) ${transform}`;
            }

            elements.textContainer.style.transform = transform;
        }

        // ===== File Handling =====
        elements.fileUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert('File is too large. Maximum size is 5MB.');
                return;
            }

            const fileName = file.name.toLowerCase();
            let text = '';

            try {
                if (fileName.endsWith('.txt') || fileName.endsWith('.md')) {
                    text = await file.text();
                } else if (fileName.endsWith('.docx')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    text = result.value;
                } else {
                    alert('Unsupported file type. Please use .txt, .md, or .docx files.');
                    return;
                }

                loadText(text);
            } catch (error) {
                alert('Error reading file: ' + error.message);
            }

            e.target.value = ''; // Reset file input
        });

        // ===== Paste Modal =====
        elements.pasteBtn.addEventListener('click', () => {
            elements.pasteModal.classList.add('show');
            elements.pasteArea.focus();
        });

        elements.pasteCancel.addEventListener('click', () => {
            elements.pasteModal.classList.remove('show');
        });

        elements.pasteLoad.addEventListener('click', () => {
            const text = elements.pasteArea.value.trim();
            if (text) {
                loadText(text);
                elements.pasteModal.classList.remove('show');
                elements.pasteArea.value = '';
            }
        });

        // Close modal on background click
        elements.pasteModal.addEventListener('click', (e) => {
            if (e.target === elements.pasteModal) {
                elements.pasteModal.classList.remove('show');
            }
        });

        // ===== Text Loading and Parsing =====
        function loadText(text) {
            state.text = text;
            state.sentences = parseSentences(text);
            state.currentSentenceIndex = 0;

            // Position text at bottom of viewport initially
            // We'll set this after the text is rendered
            displayText();

            // Wait for DOM to update, then set initial position
            setTimeout(() => {
                const viewportHeight = elements.viewport.clientHeight;
                state.scrollPosition = viewportHeight - 100; // Start with first line visible at bottom
                displayText();
            }, 0);

            updateProgress();
            stopPlayback();
        }

        function parseSentences(text) {
            // Split on period followed by space, or period at end of line
            const sentences = text.split(/\.\s+|\.\n/).filter(s => s.trim().length > 0);
            return sentences.map(s => s.trim() + '.');
        }

        function displayText() {
            if (state.sentences.length === 0) {
                elements.textContainer.innerHTML = '<p style="color: #666; text-align: center; margin-top: 100px;">Upload a file or paste text to begin</p>';
                return;
            }

            // Create sentence spans for highlighting
            const html = state.sentences.map((sentence, index) => {
                const className = index === state.currentSentenceIndex ? 'sentence current' : 'sentence';
                return `<span class="${className}">${escapeHtml(sentence)} </span>`;
            }).join('');

            elements.textContainer.innerHTML = html;
            updateTransform();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== Playback Engine =====
        function togglePlayback() {
            if (state.isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            if (state.sentences.length === 0) return;

            state.isPlaying = true;
            state.lastTimestamp = performance.now();
            elements.playPauseBtn.textContent = '‚ñê‚ñê';
            requestAnimationFrame(scrollStep);
        }

        function stopPlayback() {
            state.isPlaying = false;
            elements.playPauseBtn.textContent = '‚ñ∂';
            if (state.animationFrameId) {
                cancelAnimationFrame(state.animationFrameId);
            }
        }

        function scrollStep(timestamp) {
            if (!state.isPlaying) return;

            const deltaTime = timestamp - state.lastTimestamp;
            state.lastTimestamp = timestamp;

            // Calculate scroll distance based on WPM
            // WPM = words per minute, convert to pixels per millisecond
            const wordsPerMs = state.speed / 60000;
            const avgCharsPerWord = 5; // Approximate
            const pixelsPerChar = state.fontSize * 0.6; // Approximate character width
            const scrollSpeed = wordsPerMs * avgCharsPerWord * pixelsPerChar;

            // Scroll UP (decrease position) to reveal text from below
            state.scrollPosition -= scrollSpeed * deltaTime;

            // Update display
            updateTransform();

            // Calculate progress
            const viewportHeight = elements.viewport.clientHeight;
            const totalHeight = elements.textContainer.scrollHeight;
            const startPosition = viewportHeight - 100;
            const endPosition = -(totalHeight - viewportHeight);
            const scrollRange = startPosition - endPosition;
            const scrolled = startPosition - state.scrollPosition;
            const progress = Math.min(100, Math.max(0, (scrolled / scrollRange) * 100));
            updateProgressBar(progress);

            // Check if we've scrolled past current sentence
            updateCurrentSentence();

            // Continue animation
            state.animationFrameId = requestAnimationFrame(scrollStep);
        }

        function updateCurrentSentence() {
            // Estimate based on scroll position
            const viewportHeight = elements.viewport.clientHeight;
            const totalHeight = elements.textContainer.scrollHeight;
            const startPosition = viewportHeight - 100;
            const endPosition = -(totalHeight - viewportHeight);
            const scrollRange = startPosition - endPosition;
            const scrolled = startPosition - state.scrollPosition;
            const progress = scrolled / scrollRange;
            const estimatedIndex = Math.floor(progress * state.sentences.length);

            if (estimatedIndex !== state.currentSentenceIndex && estimatedIndex >= 0 && estimatedIndex < state.sentences.length) {
                state.currentSentenceIndex = estimatedIndex;
                displayText();
            }
        }

        // ===== Navigation =====
        function previousSentence() {
            if (state.currentSentenceIndex > 0) {
                state.currentSentenceIndex--;
                jumpToSentence(state.currentSentenceIndex);
            }
        }

        function nextSentence() {
            if (state.currentSentenceIndex < state.sentences.length - 1) {
                state.currentSentenceIndex++;
                jumpToSentence(state.currentSentenceIndex);
            }
        }

        function jumpToSentence(index) {
            state.currentSentenceIndex = index;

            // Calculate scroll position for this sentence
            const viewportHeight = elements.viewport.clientHeight;
            const totalHeight = elements.textContainer.scrollHeight;
            const startPosition = viewportHeight - 100;
            const endPosition = -(totalHeight - viewportHeight);
            const scrollRange = startPosition - endPosition;
            const sentenceProgress = index / state.sentences.length;
            state.scrollPosition = startPosition - (sentenceProgress * scrollRange);

            displayText();
            updateProgress();
        }

        // ===== Progress Indicator =====
        function updateProgress() {
            const progress = (state.currentSentenceIndex / Math.max(1, state.sentences.length - 1)) * 100;
            updateProgressBar(progress);
        }

        function updateProgressBar(progress) {
            elements.progressFill.style.width = progress + '%';
            elements.progressPercent.textContent = Math.round(progress) + '%';
        }

        // Progress bar click to seek
        elements.progressBar.addEventListener('click', (e) => {
            if (state.sentences.length === 0) return;

            const rect = elements.progressBar.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const progress = clickX / rect.width;
            const sentenceIndex = Math.floor(progress * state.sentences.length);

            jumpToSentence(Math.max(0, Math.min(sentenceIndex, state.sentences.length - 1)));
        });

        // ===== Controls =====
        elements.playPauseBtn.addEventListener('click', togglePlayback);
        elements.prevBtn.addEventListener('click', previousSentence);
        elements.nextBtn.addEventListener('click', nextSentence);

        elements.mirrorBtn.addEventListener('click', () => {
            state.mirror = !state.mirror;
            saveSetting('prompter_mirror', state.mirror);

            if (state.mirror) {
                elements.mirrorBtn.classList.add('active');
            } else {
                elements.mirrorBtn.classList.remove('active');
            }
            updateTransform();
        });

        elements.vflipBtn.addEventListener('click', () => {
            state.verticalFlip = !state.verticalFlip;
            saveSetting('prompter_verticalFlip', state.verticalFlip);

            if (state.verticalFlip) {
                elements.vflipBtn.classList.add('active');
            } else {
                elements.vflipBtn.classList.remove('active');
            }
            updateTransform();
        });

        elements.fontSlider.addEventListener('input', (e) => {
            state.fontSize = parseInt(e.target.value);
            saveSetting('prompter_fontSize', state.fontSize);
            elements.fontValue.textContent = state.fontSize;
            elements.textContainer.style.fontSize = state.fontSize + 'px';
        });

        elements.speedSlider.addEventListener('input', (e) => {
            state.speed = parseInt(e.target.value);
            saveSetting('prompter_speed', state.speed);
            elements.speedValue.textContent = state.speed;
        });

        elements.fullscreenBtn.addEventListener('click', toggleFullscreen);

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                elements.app.requestFullscreen().catch(err => {
                    alert('Error attempting to enable fullscreen: ' + err.message);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Update fullscreen button state
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                elements.app.classList.add('fullscreen');
            } else {
                elements.app.classList.remove('fullscreen');
            }
        });

        // ===== Keyboard Shortcuts =====
        document.addEventListener('keydown', (e) => {
            // Don't trigger shortcuts when typing in textarea
            if (e.target.tagName === 'TEXTAREA') return;

            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    togglePlayback();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    state.speed = Math.min(300, state.speed + 10);
                    elements.speedSlider.value = state.speed;
                    elements.speedValue.textContent = state.speed;
                    saveSetting('prompter_speed', state.speed);
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    state.speed = Math.max(60, state.speed - 10);
                    elements.speedSlider.value = state.speed;
                    elements.speedValue.textContent = state.speed;
                    saveSetting('prompter_speed', state.speed);
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    previousSentence();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextSentence();
                    break;
                case 'f':
                case 'F':
                    e.preventDefault();
                    toggleFullscreen();
                    break;
            }
        });

        // ===== Initialization =====
        loadSettings();
    </script>
</body>
</html>
